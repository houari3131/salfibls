// استدعاء مكتبة OzLiveness
var script = document.createElement('script');
script.src = "https://web-sdk.spain.prod.ozforensics.com/blsinternational/plugin_liveness.php";
document.head.appendChild(script);

script.onload = function() {
    // إضافة زر للإدخال وتنفيذ العملية بعد تحميل المكتبة
    (function() {
        var button = document.createElement("button");
        button.textContent = "بدء التحقق بالسيلفي";
        button.style.cssText = "display: block; margin: 20px auto; padding: 10px 20px; font-size: 16px; background-color: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;";

        button.onclick = function() {
            var input = prompt("الرجاء إدخال الكودين مفصولين بفاصلة:");
            if (input) {
                var codes = input.split(",");
                if (codes.length === 2 && codes[0].trim() !== "" && codes[1].trim() !== "") {
                    var user_id = codes[0].trim();
                    var transaction_id = codes[1].trim();
                    startLivenessCheck(user_id, transaction_id);
                } else {
                    alert("الرجاء التأكد من إدخال الكودين بشكل صحيح.");
                }
            } else {
                alert("لم يتم إدخال أي قيمة.");
            }
        };

        document.body.appendChild(button);

        function startLivenessCheck(user_id, transaction_id) {
            // تأكد من أن OzLiveness جاهز قبل محاولة الفتح
            if (typeof OzLiveness !== 'undefined') {
                OzLiveness.open({
                    lang: 'ar',
                    meta: {
                        'user_id': user_id,
                        'transaction_id': transaction_id
                    },
                    overlay_options: false,
                    action: [
                        'video_selfie_blank'
                    ],
                    on_complete: function (result) {
                        if (result.status === 'success') {
                            alert("الصورة جيدة وتم قبولها.");
                            $("#LivenessId").val(result.event_session_id);
                            ShowLoader();
                            $("#formLiveness").submit();
                        } else {
                            alert("الصورة غير صالحة. الرجاء المحاولة مرة أخرى.");
                            setTimeout(function() {
                                alert("سوف نعيد المحاولة الآن...");
                                startLivenessCheck(user_id, transaction_id);
                            }, 3000);
                        }
                    }
                });
            } else {
                alert("OzLiveness غير متاح. تأكد من أن السكريبت محمل بشكل صحيح.");
            }
        }
    })();
};
