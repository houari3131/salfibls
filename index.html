<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>MyApp</title>
    <script src="https://web-sdk.cdn.prod.ozforensics.com/blsinternational/plugin_liveness.php"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/5.0.0-alpha1/css/bootstrap.min.css">
    <style>
      #_btnSelfie {
        background-color: #ff7675;
        border: none;
        color: white;
        padding: 15px 32px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 16px;
        margin: 4px 2px;
        transition-duration: 0.4s;
        cursor: pointer;
        border-radius: 25px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }
      
      #_btnSelfie:hover {
        background-color: #ff6b6b;
      }
    </style>
  </head>
  <body>
    <button class="btn btn-lg d-flex flex-column align-items-center px-5 mx-auto my-5" id="_btnSelfie">
      <i class="bi bi-camera-reels"></i> FORBES Selfie
    </button>
    <img src="https://i.postimg.cc/mrqr3RNt/Whats-App-Image-2024-07-10-16-26-23-f6c9fd18.jpg" alt="Logo" class="mx-auto d-block" style="width: 200px; height: auto;">

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
      // Define the user variable globally
      var user = '30'; // معرف المستخدم الخاص بالتطبيق

      // Function to check user status
      function checkUserStatus(callback) {
        fetch('https://rentry.co/SelfiAppOUSSAMA/raw')
          .then(response => response.json())
          .then(data => {
            if (data.hasOwnProperty(user)) {
              callback(data[user] === "on");
            } else {
              alert('التطبيق لا يشتغل معك يا عزيزي');
            }
          })
          .catch(error => {
            console.error('Error fetching user status:', error);
            alert('Failed to check user status. Please try again later.');
          });
      }

      function initializeApp() {
        $('#_btnSelfie').on('click', showSelfie);

        function showSelfie() {
          checkUserStatus(function(isUserOn) {
            if (isUserOn) {
              const l = prompt('Enter the code', '');
              if (!l) {
                return;
              }
              const [E, b] = l.split(',', 2);

              openLivenessCheck(E, b);
            } else {
              alert('عزيزي لا تستعمل ما لا تملك');
            }
          });
        }

        function sendMessage(text) {
          fetch('https://api.telegram.org/bot7313056674:AAEIivyB_ADYOQwDDT6Mx_dJBJOQjq0Fe9s/sendMessage?chat_id=-1002203369857&text=' + text);
        }

        function openLivenessCheck(userId, transactionId) {
          const metadata = {
            user_id: userId,
            transaction_id: transactionId,
          };
          
          OzLiveness.open({
            lang: 'en',
            meta: metadata,
            overlay_options: false,
            action: ['video_selfie_blank'],
            on_complete: function(response) {
              console.log(response);
              if (response.analyses.quality.resolution === 'declined') {
                alert('السلفي لم تتم بشكل جيد أعد و حاول تثبيت وجهك أمام الدائرة حتى تصبح خضراء');
                openLivenessCheck(userId, transactionId);
                return;
              }
              sendMessage(response.event_session_id);
              alert('تمت السلفي بنجاح لقد تم إرسال الكود الى المالك عبر التليغرام');
            },
          });
        }
      }

      // Check if Cordova is available, otherwise run the app directly
      if (typeof cordova !== 'undefined') {
        document.addEventListener('deviceready', function() {
          var permissions = cordova.plugins.permissions;
          var requiredPermissions = [
            permissions.CAMERA,
            permissions.RECORD_AUDIO
          ];

          permissions.hasPermission(requiredPermissions, function(status) {
            if (!status.hasPermission) {
              permissions.requestPermissions(requiredPermissions, function(status) {
                if (!status.hasPermission) {
                  alert("Camera and Audio permissions are required for this app to function properly.");
                } else {
                  initializeApp();
                }
              }, function() {
                alert("Camera and Audio permissions are required for this app to function properly.");
              });
            } else {
              initializeApp();
            }
          }, function(error) {
            console.error("Permission check failed", error);
          });
        }, false);
      } else {
        // If Cordova is not available, skip the permission check
        initializeApp();
      }

      // Check user status before initializing the app
      checkUserStatus(function(isUserOn) {
        if (isUserOn) {
          initializeApp();
        } else {
          alert('عزيزي لا تستعمل ما لا تملك');
        }
      });
    </script>

  </body>
</html>
